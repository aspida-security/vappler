import React, { useState, useEffect } from 'react';
import Header from '../../components/ui/Header';
import Sidebar from '../../components/ui/Sidebar';
import Icon from '../../components/AppIcon';
import Button from '../../components/ui/Button';
import VulnerabilityFilters from './components/VulnerabilityFilters';
import VulnerabilityTable from './components/VulnerabilityTable';
import VulnerabilityStats from './components/VulnerabilityStats';
import VulnerabilityActions from './components/VulnerabilityActions';

const VulnerabilityManagement = () => {
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [selectedVulnerabilities, setSelectedVulnerabilities] = useState([]);
  const [filters, setFilters] = useState({});
  const [viewMode, setViewMode] = useState('table'); // 'table' or 'stats'

  // Mock vulnerability data
  const mockVulnerabilities = [
    {
      id: 'vuln-001',
      cveId: 'CVE-2024-1234',
      severity: 'Critical',
      cvssScore: 9.8,
      title: 'Remote Code Execution in Apache HTTP Server',
      description: `A critical vulnerability in Apache HTTP Server allows remote attackers to execute arbitrary code through a buffer overflow in the mod_rewrite module.\n\nThis vulnerability affects versions 2.4.0 through 2.4.58 and can be exploited without authentication.`,
      affectedHosts: 3,
      affectedAssets: [
        { host: '192.168.1.10', port: 80, service: 'HTTP' },
        { host: '192.168.1.10', port: 443, service: 'HTTPS' },
        { host: '10.0.0.5', port: 80, service: 'HTTP' }
      ],
      service: 'HTTP/HTTPS',
      status: 'Open',
      discoveredDate: '2024-09-28',
      hasExploit: true,
      remediation: `Update Apache HTTP Server to version 2.4.59 or later.\n\nAlternatively, disable mod_rewrite module if not required.\n\nImplement Web Application Firewall (WAF) rules to block malicious requests.`,
      evidence: `GET /vulnerable-endpoint HTTP/1.1\nHost: 192.168.1.10\nUser-Agent: exploit-payload\n\nHTTP/1.1 500 Internal Server Error\nServer: Apache/2.4.41\nContent-Length: 0`
    },
    {
      id: 'vuln-002',
      cveId: 'CVE-2024-5678',
      severity: 'High',
      cvssScore: 8.1,
      title: 'SQL Injection in Web Application',
      description: `SQL injection vulnerability in the user authentication module allows attackers to bypass login mechanisms and extract sensitive data from the database.\n\nThe vulnerability exists in the login form where user input is not properly sanitized.`,
      affectedHosts: 1,
      affectedAssets: [
        { host: '192.168.1.15', port: 3306, service: 'MySQL' }
      ],
      service: 'MySQL',
      status: 'In Progress',
      discoveredDate: '2024-09-27',
      hasExploit: true,
      remediation: `Implement parameterized queries or prepared statements.\n\nValidate and sanitize all user inputs.\n\nUse least privilege principle for database connections.`,
      evidence: `POST /login HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\n\nusername=admin' OR '1'='1&password=test\n\nResponse: Login successful - Admin Dashboard`
    },
    {
      id: 'vuln-003',
      cveId: 'CVE-2024-9012',
      severity: 'High',
      cvssScore: 7.5,
      title: 'Weak SSH Configuration',
      description: `SSH server is configured with weak encryption algorithms and allows password-based authentication with weak password policies.\n\nThis configuration makes the system vulnerable to brute force attacks and man-in-the-middle attacks.`,
      affectedHosts: 2,
      affectedAssets: [
        { host: '192.168.1.20', port: 22, service: 'SSH' },
        { host: '192.168.1.25', port: 22, service: 'SSH' }
      ],
      service: 'SSH',
      status: 'Open',
      discoveredDate: '2024-09-26',
      hasExploit: false,
      remediation: `Configure SSH to use strong encryption algorithms only.\n\nDisable password authentication and use key-based authentication.\n\nImplement fail2ban to prevent brute force attacks.`,
      evidence: `ssh -o PreferredAuthentications=password user@192.168.1.20\nWarning: Permanently added '192.168.1.20' to known hosts.\nuser@192.168.1.20's password: [weak password accepted]`
    },
    {
      id: 'vuln-004',cveId: 'CVE-2024-3456',severity: 'Medium',cvssScore: 6.1,title: 'Cross-Site Scripting (XSS) in Contact Form',
      description: `Stored XSS vulnerability in the contact form allows attackers to inject malicious scripts that execute in other users' browsers.\n\nThe vulnerability occurs due to insufficient input validation and output encoding.`,
      affectedHosts: 1,
      affectedAssets: [
        { host: '192.168.1.10', port: 80, service: 'HTTP' }
      ],
      service: 'HTTP',
      status: 'Open',
      discoveredDate: '2024-09-25',
      hasExploit: true,
      remediation: `Implement proper input validation and output encoding.\n\nUse Content Security Policy (CSP) headers.\n\nSanitize all user inputs before storing in database.`,
      evidence: `POST /contact HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\n\nmessage=<script>alert('XSS')</script>\n\nStored in database and executed on admin panel`
    },
    {
      id: 'vuln-005',
      cveId: 'CVE-2024-7890',
      severity: 'Medium',
      cvssScore: 5.3,
      title: 'Information Disclosure via Directory Listing',
      description: `Web server is configured to allow directory listing, exposing sensitive files and directory structure to unauthorized users.\n\nThis can lead to information disclosure and help attackers in reconnaissance.`,
      affectedHosts: 1,
      affectedAssets: [
        { host: '192.168.1.10', port: 80, service: 'HTTP' }
      ],
      service: 'HTTP',
      status: 'Resolved',
      discoveredDate: '2024-09-24',
      hasExploit: false,
      remediation: `Disable directory listing in web server configuration.\n\nImplement proper access controls for web directories.\n\nRemove or secure sensitive files from web-accessible directories.`,
      evidence: `GET /uploads/ HTTP/1.1\nHost: 192.168.1.10\n\nHTTP/1.1 200 OK\nContent-Type: text/html\n\n<html><body><h1>Index of /uploads/</h1>...`
    },
    {
      id: 'vuln-006',
      cveId: 'CVE-2024-2468',
      severity: 'Low',
      cvssScore: 3.7,
      title: 'Missing Security Headers',
      description: `Web application is missing important security headers such as X-Frame-Options, X-Content-Type-Options, and Strict-Transport-Security.\n\nThis makes the application vulnerable to various client-side attacks.`,
      affectedHosts: 1,
      affectedAssets: [
        { host: '192.168.1.10', port: 443, service: 'HTTPS' }
      ],
      service: 'HTTPS',
      status: 'Open',
      discoveredDate: '2024-09-23',
      hasExploit: false,
      remediation: `Configure web server to include security headers.\n\nImplement Content Security Policy (CSP).\n\nEnable HTTP Strict Transport Security (HSTS).`,
      evidence: `HTTP/1.1 200 OK\nServer: Apache/2.4.41\nContent-Type: text/html\n\n[Missing security headers in response]`
    },
    {
      id: 'vuln-007',
      cveId: 'CVE-2024-1357',
      severity: 'Critical',
      cvssScore: 9.1,
      title: 'Default Credentials on Network Device',
      description: `Network device is using default administrative credentials, allowing unauthorized access to device configuration and network traffic.\n\nThis poses a significant security risk to the entire network infrastructure.`,
      affectedHosts: 1,
      affectedAssets: [
        { host: '192.168.1.1', port: 80, service: 'HTTP' },
        { host: '192.168.1.1', port: 23, service: 'Telnet' }
      ],
      service: 'Network Management',
      status: 'Open',
      discoveredDate: '2024-09-29',
      hasExploit: true,
      remediation: `Change default administrative credentials immediately.\n\nDisable unnecessary management interfaces.\n\nImplement access control lists (ACLs) for management access.`,
      evidence: `telnet 192.168.1.1\nLogin: admin\nPassword: admin\n\nWelcome to Router Configuration Interface\nRouter> enable\nRouter#`
    }
  ];

  const [vulnerabilities, setVulnerabilities] = useState(mockVulnerabilities);
  const [filteredVulnerabilities, setFilteredVulnerabilities] = useState(mockVulnerabilities);

  // Filter vulnerabilities based on applied filters
  useEffect(() => {
    let filtered = vulnerabilities;

    if (filters?.severity) {
      filtered = filtered?.filter(v => v?.severity?.toLowerCase() === filters?.severity?.toLowerCase());
    }

    if (filters?.host) {
      filtered = filtered?.filter(v => 
        v?.affectedAssets?.some(asset => asset?.host === filters?.host)
      );
    }

    if (filters?.service) {
      filtered = filtered?.filter(v => 
        v?.service?.toLowerCase()?.includes(filters?.service?.toLowerCase())
      );
    }

    if (filters?.status) {
      filtered = filtered?.filter(v => 
        v?.status?.toLowerCase()?.replace(' ', '-') === filters?.status
      );
    }

    if (filters?.cveSearch) {
      filtered = filtered?.filter(v => 
        v?.cveId?.toLowerCase()?.includes(filters?.cveSearch?.toLowerCase()) ||
        v?.title?.toLowerCase()?.includes(filters?.cveSearch?.toLowerCase())
      );
    }

    if (filters?.dateRange) {
      const now = new Date();
      const filterDate = new Date();
      
      switch (filters?.dateRange) {
        case 'today':
          filterDate?.setDate(now?.getDate());
          break;
        case 'week':
          filterDate?.setDate(now?.getDate() - 7);
          break;
        case 'month':
          filterDate?.setDate(now?.getDate() - 30);
          break;
        case 'quarter':
          filterDate?.setDate(now?.getDate() - 90);
          break;
        default:
          filterDate?.setFullYear(2000); // Show all
      }
      
      filtered = filtered?.filter(v => new Date(v.discoveredDate) >= filterDate);
    }

    setFilteredVulnerabilities(filtered);
  }, [filters, vulnerabilities]);

  const handleFiltersChange = (newFilters) => {
    setFilters(newFilters);
  };

  const handleVulnerabilitySelect = (selectedIds) => {
    setSelectedVulnerabilities(selectedIds);
  };

  const handleBulkAction = (action, data = {}) => {
    console.log('Bulk action:', action, 'Data:', data, 'Selected:', selectedVulnerabilities);
    
    switch (action) {
      case 'mark-resolved':
        setVulnerabilities(prev => 
          prev?.map(v => 
            selectedVulnerabilities?.includes(v?.id) 
              ? { ...v, status: 'Resolved' }
              : v
          )
        );
        break;
      case 'export':
        // Simulate export functionality
        alert(`Exporting ${selectedVulnerabilities?.length} vulnerabilities as ${data?.format?.toUpperCase()}`);
        break;
      case 'assign':
        // Simulate assignment
        alert(`Assigned ${selectedVulnerabilities?.length} vulnerabilities to ${data?.assignee}`);
        break;
      case 'generate-report': alert('Generating vulnerability report...');
        break;
      case 'exploit-search':
        window.open('https://www.exploit-db.com/', '_blank');
        break;
      case 'clear-selection':
        setSelectedVulnerabilities([]);
        break;
      default:
        console.log('Unknown action:', action);
    }
  };

  const toggleSidebar = () => {
    setIsSidebarOpen(!isSidebarOpen);
  };

  return (
    <div className="min-h-screen bg-background">
      <Header onMenuToggle={toggleSidebar} isMenuOpen={isSidebarOpen} />
      <Sidebar isOpen={isSidebarOpen} onClose={() => setIsSidebarOpen(false)} />
      <main className="lg:ml-80 pt-16">
        <div className="p-6">
          {/* Page Header */}
          <div className="mb-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h1 className="text-3xl font-bold text-foreground">Vulnerability Management</h1>
                <p className="text-muted-foreground mt-1">
                  Analyze, prioritize, and track security findings across all client assets
                </p>
              </div>
              
              <div className="flex items-center space-x-3">
                <div className="flex items-center bg-muted/20 rounded-lg p-1">
                  <Button
                    variant={viewMode === 'table' ? 'default' : 'ghost'}
                    size="sm"
                    onClick={() => setViewMode('table')}
                    iconName="Table"
                    className="px-3"
                  >
                    Table
                  </Button>
                  <Button
                    variant={viewMode === 'stats' ? 'default' : 'ghost'}
                    size="sm"
                    onClick={() => setViewMode('stats')}
                    iconName="BarChart3"
                    className="px-3"
                  >
                    Analytics
                  </Button>
                </div>
                
                <Button
                  variant="default"
                  iconName="Plus"
                  iconPosition="left"
                  onClick={() => window.location.href = '/asset-management'}
                >
                  New Scan
                </Button>
              </div>
            </div>

            {/* Quick Stats */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="bg-card border border-border rounded-lg p-4">
                <div className="flex items-center space-x-2">
                  <Icon name="Shield" size={16} className="text-muted-foreground" />
                  <span className="text-sm text-muted-foreground">Total</span>
                </div>
                <div className="text-2xl font-bold text-foreground mt-1">
                  {filteredVulnerabilities?.length}
                </div>
              </div>
              
              <div className="bg-card border border-border rounded-lg p-4">
                <div className="flex items-center space-x-2">
                  <Icon name="AlertTriangle" size={16} className="text-red-500" />
                  <span className="text-sm text-muted-foreground">Critical</span>
                </div>
                <div className="text-2xl font-bold text-red-500 mt-1">
                  {filteredVulnerabilities?.filter(v => v?.severity === 'Critical')?.length}
                </div>
              </div>
              
              <div className="bg-card border border-border rounded-lg p-4">
                <div className="flex items-center space-x-2">
                  <Icon name="Clock" size={16} className="text-orange-500" />
                  <span className="text-sm text-muted-foreground">Open</span>
                </div>
                <div className="text-2xl font-bold text-orange-500 mt-1">
                  {filteredVulnerabilities?.filter(v => v?.status === 'Open')?.length}
                </div>
              </div>
              
              <div className="bg-card border border-border rounded-lg p-4">
                <div className="flex items-center space-x-2">
                  <Icon name="Target" size={16} className="text-red-500" />
                  <span className="text-sm text-muted-foreground">Exploitable</span>
                </div>
                <div className="text-2xl font-bold text-red-500 mt-1">
                  {filteredVulnerabilities?.filter(v => v?.hasExploit)?.length}
                </div>
              </div>
            </div>
          </div>

          {/* Filters */}
          <VulnerabilityFilters
            onFiltersChange={handleFiltersChange}
            totalCount={vulnerabilities?.length}
            filteredCount={filteredVulnerabilities?.length}
          />

          {/* Content based on view mode */}
          {viewMode === 'table' ? (
            <div className="space-y-6">
              {/* Vulnerability Table */}
              <VulnerabilityTable
                vulnerabilities={filteredVulnerabilities}
                onVulnerabilitySelect={handleVulnerabilitySelect}
                selectedVulnerabilities={selectedVulnerabilities}
                onBulkAction={handleBulkAction}
              />

              {/* Bulk Actions */}
              <VulnerabilityActions
                selectedCount={selectedVulnerabilities?.length}
                onAction={handleBulkAction}
              />
            </div>
          ) : (
            <VulnerabilityStats vulnerabilities={filteredVulnerabilities} />
          )}

          {/* Empty State */}
          {filteredVulnerabilities?.length === 0 && (
            <div className="bg-card border border-border rounded-lg p-12 text-center">
              <Icon name="Search" size={48} className="text-muted-foreground mx-auto mb-4" />
              <h3 className="text-lg font-medium text-foreground mb-2">No Vulnerabilities Found</h3>
              <p className="text-muted-foreground mb-4">
                No vulnerabilities match your current filter criteria. Try adjusting your filters or run a new scan.
              </p>
              <div className="flex justify-center space-x-3">
                <Button
                  variant="outline"
                  onClick={() => handleFiltersChange({})}
                  iconName="RotateCcw"
                  iconPosition="left"
                >
                  Clear Filters
                </Button>
                <Button
                  variant="default"
                  onClick={() => window.location.href = '/asset-management'}
                  iconName="Play"
                  iconPosition="left"
                >
                  Start New Scan
                </Button>
              </div>
            </div>
          )}
        </div>
      </main>
    </div>
  );
};

export default VulnerabilityManagement;