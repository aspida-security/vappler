import React, { useState, useEffect } from 'react';
import Icon from '../../components/AppIcon';
import Button from '../../components/ui/Button';
import VulnerabilityFilters from './components/VulnerabilityFilters';
import VulnerabilityTable from './components/VulnerabilityTable';
import VulnerabilityStats from './components/VulnerabilityStats';
import VulnerabilityActions from './components/VulnerabilityActions';

const VulnerabilityManagement = () => {
  const [selectedVulnerabilities, setSelectedVulnerabilities] = useState([]);
  const [filters, setFilters] = useState({});
  const [viewMode, setViewMode] = useState('table');
  const [vulnerabilities, setVulnerabilities] = useState([]); // Will be fetched from API
  const [filteredVulnerabilities, setFilteredVulnerabilities] = useState([]);

  // Mock data - we will replace this with a service call later
  const mockVulnerabilities = [
     { id: 'vuln-001', cveId: 'CVE-2024-1234', severity: 'Critical', cvssScore: 9.8, title: 'Remote Code Execution in Apache HTTP Server', affectedHosts: 3, service: 'HTTP/HTTPS', status: 'Open', discoveredDate: '2024-09-28', hasExploit: true },
     { id: 'vuln-002', cveId: 'CVE-2024-5678', severity: 'High', cvssScore: 8.1, title: 'SQL Injection in Web Application', affectedHosts: 1, service: 'MySQL', status: 'In Progress', discoveredDate: '2024-09-27', hasExploit: true },
  ];

  useEffect(() => {
    // In the future, we will fetch real data here. For now, use mock data.
    setVulnerabilities(mockVulnerabilities);
    setFilteredVulnerabilities(mockVulnerabilities);
  }, []);


  const handleFiltersChange = (newFilters) => {
    setFilters(newFilters);
  };

  const handleBulkAction = (action, data = {}) => {
    console.log(`Action: ${action}`, data);
  };

  return (
    <div className="space-y-6">
        {/* Page Header */}
        <div>
            <div className="flex items-center justify-between mb-4">
                <div>
                <h1 className="text-3xl font-bold text-foreground">Vulnerability Management</h1>
                <p className="text-muted-foreground mt-1">
                    Analyze, prioritize, and track security findings across all client assets
                </p>
                </div>
                
                <div className="flex items-center space-x-3">
                <div className="flex items-center bg-muted/20 rounded-lg p-1">
                    <Button variant={viewMode === 'table' ? 'default' : 'ghost'} size="sm" onClick={() => setViewMode('table')} iconName="Table">Table</Button>
                    <Button variant={viewMode === 'stats' ? 'default' : 'ghost'} size="sm" onClick={() => setViewMode('stats')} iconName="BarChart3">Analytics</Button>
                </div>
                <Button variant="default" iconName="Plus" iconPosition="left">New Scan</Button>
                </div>
            </div>
        </div>

        {/* Filters */}
        <VulnerabilityFilters
            onFiltersChange={handleFiltersChange}
            totalCount={vulnerabilities.length}
            filteredCount={filteredVulnerabilities.length}
        />

        {/* Content */}
        {viewMode === 'table' ? (
        <div>
            <VulnerabilityTable
                vulnerabilities={filteredVulnerabilities}
                onVulnerabilitySelect={setSelectedVulnerabilities}
                selectedVulnerabilities={selectedVulnerabilities}
                onBulkAction={handleBulkAction}
            />
        </div>
        ) : (
        <VulnerabilityStats vulnerabilities={filteredVulnerabilities} />
        )}
    </div>
  );
};

export default VulnerabilityManagement;