import React, { useMemo } from 'react';
import Icon from '../../../components/AppIcon';
import { 
  BarChart, 
  Bar, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer, 
  PieChart, 
  Pie, 
  Cell,
  LineChart,
  Line,
  Legend
} from 'recharts';

// --- HELPER COLORS ---
const COLORS = {
  CRITICAL: 'var(--color-destructive)', // Red
  HIGH: 'var(--color-warning)',      // Orange
  MEDIUM: 'var(--color-medium)',     // Yellow
  LOW: 'var(--color-info)',        // Blue
};

const VulnerabilityAnalytics = ({ vulnerabilities, stats }) => {

  // Calculate severity distribution
  const severityDistribution = useMemo(() => {
    const data = [
      { name: 'Critical', value: stats.critical, color: COLORS.CRITICAL },
      { name: 'High', value: vulnerabilities.filter(v => v.severity === 'High').length, color: COLORS.HIGH },
      { name: 'Medium', value: vulnerabilities.filter(v => v.severity === 'Medium').length, color: COLORS.MEDIUM },
      { name: 'Low', value: vulnerabilities.filter(v => v.severity === 'Low').length, color: COLORS.LOW },
    ];
    const total = data.reduce((sum, entry) => sum + entry.value, 0);
    return { data, total };
  }, [vulnerabilities, stats]);

  // Calculate 7-day trend
  const sevenDayTrend = useMemo(() => {
    const days = [];
    const today = new Date();
    for (let i = 6; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      date.setHours(0, 0, 0, 0);
      const nextDate = new Date(date);
      nextDate.setDate(nextDate.getDate() + 1);

      const vulnsOnDay = vulnerabilities.filter(v => {
        const discoveredDate = new Date(v.discovered_at);
        return discoveredDate >= date && discoveredDate < nextDate;
      });

      days.push({
        date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
        Critical: vulnsOnDay.filter(v => v.severity === 'Critical').length,
        High: vulnsOnDay.filter(v => v.severity === 'High').length,
        Medium: vulnsOnDay.filter(v => v.severity === 'Medium').length,
        Low: vulnsOnDay.filter(v => v.severity === 'Low').length,
      });
    }
    return days;
  }, [vulnerabilities]);

  // Calculate most vulnerable hosts
  const mostVulnerableHosts = useMemo(() => {
    const hostMap = {};
    vulnerabilities.forEach(v => {
      const host = v.assets?.ip_address || 'Unknown';
      if (!hostMap[host]) {
        hostMap[host] = { host, total: 0, Critical: 0, High: 0, Medium: 0, Low: 0 };
      }
      hostMap[host].total++;
      const severity = v.severity || 'Info';
      hostMap[host][severity] = (hostMap[host][severity] || 0) + 1;
    });
    return Object.values(hostMap).sort((a, b) => b.total - a.total).slice(0, 5);
  }, [vulnerabilities]);

  // Risk assessment categories
  const riskAssessment = useMemo(() => {
    return {
      critical: stats.critical,
      high: vulnerabilities.filter(v => (v.severity === 'High' || v.severity === 'Medium') && v.status === 'open').length,
      low: vulnerabilities.filter(v => v.severity === 'Low' || v.status !== 'open').length,
    };
  }, [vulnerabilities, stats]);

  return (
    <div className="space-y-6">
      {/* Severity Distribution & 7-Day Trend */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        {/* Severity Distribution Pie Chart */}
        <div className="bg-surface border border-border rounded-lg p-6">
          <div className="flex items-center justify-between mb-6">
            <h3 className="font-semibold">Severity Distribution</h3>
            <Icon name="PieChart" className="w-5 h-5 text-text-secondary" />
          </div>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie
                  data={severityDistribution.data}
                  dataKey="value"
                  cx="50%"
                  cy="50%"
                  outerRadius={80}
                  innerRadius={50}
                  labelLine={false}
                  label={({ name, value }) => value > 0 ? `${name}: ${value}` : ''}
                >
                  {severityDistribution.data.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.color} />
                  ))}
                </Pie>
                <Tooltip 
                  contentStyle={{
                    backgroundColor: 'var(--color-popover)',
                    border: '1px solid var(--color-border)',
                  }}
                />
                <text x="50%" y="50%" textAnchor="middle" dominantBaseline="middle" fill="var(--color-foreground)" fontSize="24" fontWeight="bold">
                  {severityDistribution.total}
                </text>
                <text x="50%" y="58%" textAnchor="middle" dominantBaseline="middle" fill="var(--color-text-secondary)" fontSize="12">
                  Total
                </text>
              </PieChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* 7-Day Trend Line Chart */}
        <div className="bg-surface border border-border rounded-lg p-6">
          <div className="flex items-center justify-between mb-6">
            <h3 className="font-semibold">7-Day Trend</h3>
            <Icon name="TrendingUp" className="w-5 h-5 text-text-secondary" />
          </div>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <LineChart data={sevenDayTrend} margin={{ top: 5, right: 10, left: -20, bottom: 5 }}>
                <CartesianGrid stroke="var(--color-border)" strokeDasharray="3 3" vertical={false} />
                <XAxis dataKey="date" stroke="var(--color-muted-foreground)" fontSize={12} tickLine={false} axisLine={false} />
                <YAxis stroke="var(--color-muted-foreground)" fontSize={12} tickLine={false} axisLine={false} />
                <Tooltip 
                  contentStyle={{
                    backgroundColor: 'var(--color-popover)',
                    border: '1px solid var(--color-border)',
                  }}
                  cursor={{ stroke: 'var(--color-muted-foreground)', strokeDasharray: '3 3' }}
                />
                <Legend wrapperStyle={{ fontSize: '12px' }} iconType="circle" />
                <Line type="monotone" dataKey="Critical" stroke={COLORS.CRITICAL} strokeWidth={2} dot={false} />
                <Line type="monotone" dataKey="High" stroke={COLORS.HIGH} strokeWidth={2} dot={false} />
                <Line type="monotone" dataKey="Medium" stroke={COLORS.MEDIUM} strokeWidth={2} dot={false} />
                <Line type="monotone" dataKey="Low" stroke={COLORS.LOW} strokeWidth={2} dot={false} />
              </LineChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>

      {/* Most Vulnerable Hosts */}
      <div className="bg-surface border border-border rounded-lg p-6">
        <div className="flex items-center justify-between mb-6">
          <h3 className="font-semibold">Most Vulnerable Hosts</h3>
          <Icon name="SlidersHorizontal" className="w-5 h-5 text-text-secondary" />
        </div>
        <div className="h-64">
          {mostVulnerableHosts.length === 0 ? (
            <p className="text-center text-text-secondary py-8">No vulnerable hosts found</p>
          ) : (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={mostVulnerableHosts} margin={{ top: 5, right: 0, left: 0, bottom: 5 }}>
                <CartesianGrid stroke="var(--color-border)" strokeDasharray="3 3" vertical={false} />
                <XAxis dataKey="host" stroke="var(--color-muted-foreground)" fontSize={12} tickLine={false} axisLine={false} />
                <YAxis stroke="var(--color-muted-foreground)" fontSize={12} tickLine={false} axisLine={false} />
                <Tooltip 
                  contentStyle={{
                    backgroundColor: 'var(--color-popover)',
                    border: '1px solid var(--color-border)',
                  }}
                  cursor={{ fill: 'var(--color-muted-foreground)', opacity: 0.1 }}
                />
                <Legend wrapperStyle={{ fontSize: '12px', paddingTop: '10px' }} iconType="circle" />
                <Bar dataKey="Critical" stackId="a" fill={COLORS.CRITICAL} name="Critical" />
                <Bar dataKey="High" stackId="a" fill={COLORS.HIGH} name="High" />
                <Bar dataKey="Medium" stackId="a" fill={COLORS.MEDIUM} name="Medium" />
                <Bar dataKey="Low" stackId="a" fill={COLORS.LOW} name="Low" />
              </BarChart>
            </ResponsiveContainer>
          )}
        </div>
      </div>

      {/* Risk Assessment Cards */}
      <div className="bg-surface border border-border rounded-lg p-6">
        <div className="flex items-center justify-between mb-6">
          <h3 className="font-semibold">Risk Assessment</h3>
          <Icon name="Target" className="w-5 h-5 text-text-secondary" />
        </div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <RiskCard
            level="High Risk"
            count={riskAssessment.critical}
            description="vulnerabilities require immediate attention"
            color="destructive"
          />
          <RiskCard
            level="Medium Risk"
            count={riskAssessment.high}
            description="vulnerabilities should be addressed soon"
            color="warning"
          />
          <RiskCard
            level="Low Risk"
            count={riskAssessment.low}
            description="vulnerabilities can be scheduled for later"
            color="info"
          />
        </div>
      </div>
    </div>
  );
};

// Risk Assessment Card
const RiskCard = ({ level, count, description, color }) => {
  const colorClasses = {
    destructive: 'bg-error/10 border-error/20',
    warning: 'bg-warning/10 border-warning/20',
    info: 'bg-info/10 border-info/20'
  };

  const textColors = {
    destructive: 'text-error',
    warning: 'text-warning',
    info: 'text-info'
  };

  return (
    <div className={`border rounded-lg p-6 ${colorClasses[color]}`}>
      <h3 className={`text-lg font-bold mb-2 ${textColors[color]}`}>{level}</h3>
      <div className="text-4xl font-bold mb-2 text-text-foreground">{count}</div>
      <p className="text-sm text-text-secondary">{description}</p>
    </div>
  );
};

export default VulnerabilityAnalytics;