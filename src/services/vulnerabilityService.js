import { supabase } from '../lib/supabase';

export const vulnerabilityService = {
  // Get all vulnerabilities for a workspace
  async getVulnerabilities(workspaceId, filters = {}) {
    try {
      let query = supabase
        ?.from('vulnerabilities')
        ?.select(`
          *,
          assets:asset_id(hostname, ip_address, operating_system),
          scans:scan_id(name, completed_at)
        `)
        ?.eq('workspace_id', workspaceId)
        ?.order('discovered_at', { ascending: false });

      if (filters?.severity) query = query?.eq('severity', filters?.severity);
      if (filters?.status) query = query?.eq('status', filters?.status);
      if (filters?.cve_id) query = query?.ilike('cve_id', `%${filters?.cve_id}%`);

      const { data, error } = await query;
      if (error) throw error;
      return { data, error: null };
    } catch (error) {
      return { data: null, error: error?.message };
    }
  },
  
  async createVulnerability(vulnerabilityData) {
    try {
      const { data, error } = await supabase
        .from('vulnerabilities')
        .insert(vulnerabilityData)
        .select()
        .single();
      
      if (error) {
        // Return the full, detailed error from Supabase
        throw error;
      }
      return { data, error: null };
    } catch (error) {
      // The error object from the 'throw' above is caught here
      return { data: null, error };
    }
  },

  // Other functions remain unchanged...
  async getTopVulnerabilities(workspaceId, limit = 10) {
    try {
      const { data, error } = await supabase
        ?.from('vulnerabilities')
        ?.select(`*, assets:asset_id(hostname, ip_address, operating_system)`)
        ?.eq('workspace_id', workspaceId)
        ?.eq('status', 'open')
        ?.order('cvss_score', { ascending: false })
        ?.limit(limit);
      if (error) throw error;
      return { data, error: null };
    } catch (error) {
      return { data: null, error: error?.message };
    }
  },
  async getVulnerabilityStats(workspaceId) {
    try {
      const { data, error } = await supabase?.from('vulnerabilities')?.select('severity, status')?.eq('workspace_id', workspaceId);
      if (error) throw error;
      const stats = {
        total: data?.length || 0,
        critical: data?.filter(v => v?.severity === 'Critical')?.length || 0,
        high: data?.filter(v => v?.severity === 'High')?.length || 0,
        medium: data?.filter(v => v?.severity === 'Medium')?.length || 0,
        low: data?.filter(v => v?.severity === 'Low')?.length || 0,
        open: data?.filter(v => v?.status === 'open')?.length || 0,
      };
      return { data: stats, error: null };
    } catch (error) {
      return { data: null, error: error?.message };
    }
  },
  async getVulnerability(id) {
    try {
      const { data, error } = await supabase?.from('vulnerabilities')?.select(`*, assets:asset_id(hostname, ip_address), scans:scan_id(name)`).eq('id', id).single();
      if (error) throw error;
      return { data, error: null };
    } catch (error) {
      return { data: null, error: error?.message };
    }
  },
  async updateVulnerabilityStatus(id, status) {
    try {
      const { data, error } = await supabase.from('vulnerabilities').update({ status, updated_at: new Date()?.toISOString() }).eq('id', id).select().single();
      if (error) throw error;
      return { data, error: null };
    } catch (error) {
      return { data: null, error: error.message };
    }
  },
};