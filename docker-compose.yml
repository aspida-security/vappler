version: '3.8'

services:
  redis:
    image: "redis:alpine"
    container_name: vappler-redis
    networks:
      - vappler-net

  api:
    build: .
    container_name: vappler-api
    ports:
      - "5000:5000"
    depends_on:
      - redis
    cap_add:
      - NET_RAW
      - NET_ADMIN
    tty: true
    networks:
      - vappler-net
    environment:
      # Supabase connection (uses host.docker.internal to reach host machine)
      - SUPABASE_URL=http://host.docker.internal:63321
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      # Redis connection
      - REDIS_URL=redis://vappler-redis:6379/0
      # CORS for frontend
      - CORS_ORIGINS=http://localhost:4028,http://localhost:5173
      # Flask environment
      - FLASK_ENV=development

  worker:
    build: .
    container_name: vappler-worker
    command: celery -A tasks.celery_app worker --loglevel=info
    depends_on:
      - redis
    cap_add:
      - NET_RAW
      - NET_ADMIN
    tty: true
    networks:
      - vappler-net
    environment:
      # Worker needs Supabase access
      - SUPABASE_URL=http://host.docker.internal:63321
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      # Redis connection
      - REDIS_URL=redis://vappler-redis:6379/0
      # âœ… ADD THIS LINE:
      - DATABASE_URL=postgresql://postgres:postgres@host.docker.internal:63322/postgres

  test-target:
    image: "httpd:alpine"
    container_name: vappler-test-target
    ports:
      - "8080:80"
    networks:
      - vappler-net

networks:
  vappler-net:
    driver: bridge