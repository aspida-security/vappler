-- Location: supabase/migrations/20250930223618_vulcan_vulnerability_management_system.sql
-- Schema Analysis: Fresh project - no existing schema
-- Integration Type: Complete new schema for vulnerability management system
-- Dependencies: None - creating complete system

-- 1. Extensions & Types
CREATE TYPE public.user_role AS ENUM ('admin', 'analyst', 'viewer', 'client');
CREATE TYPE public.severity_level AS ENUM ('Critical', 'High', 'Medium', 'Low', 'Info');
CREATE TYPE public.scan_status AS ENUM ('scheduled', 'running', 'completed', 'failed', 'cancelled');
CREATE TYPE public.vulnerability_status AS ENUM ('open', 'confirmed', 'false_positive', 'remediated', 'accepted');
CREATE TYPE public.asset_type AS ENUM ('server', 'workstation', 'network_device', 'web_application', 'database', 'mobile_device');

-- 2. Core Tables - User Management
CREATE TABLE public.user_profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT NOT NULL UNIQUE,
    full_name TEXT NOT NULL,
    role public.user_role DEFAULT 'analyst'::public.user_role,
    organization TEXT,
    avatar_url TEXT,
    is_active BOOLEAN DEFAULT true,
    last_login_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 3. Client Workspaces
CREATE TABLE public.workspaces (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    description TEXT,
    owner_id UUID REFERENCES public.user_profiles(id) ON DELETE CASCADE,
    client_name TEXT,
    client_contact_email TEXT,
    client_contact_phone TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 4. Assets Management
CREATE TABLE public.assets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID REFERENCES public.workspaces(id) ON DELETE CASCADE,
    hostname TEXT,
    ip_address INET NOT NULL,
    asset_type public.asset_type DEFAULT 'server'::public.asset_type,
    operating_system TEXT,
    os_version TEXT,
    mac_address MACADDR,
    open_ports INTEGER[],
    risk_score DECIMAL(3,1) DEFAULT 0.0,
    is_active BOOLEAN DEFAULT true,
    last_scan_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 5. Scan Management
CREATE TABLE public.scans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID REFERENCES public.workspaces(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    description TEXT,
    scan_type TEXT DEFAULT 'vulnerability_scan',
    status public.scan_status DEFAULT 'scheduled'::public.scan_status,
    target_count INTEGER DEFAULT 0,
    progress INTEGER DEFAULT 0,
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    duration_minutes INTEGER,
    created_by UUID REFERENCES public.user_profiles(id) ON DELETE SET NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 6. Vulnerabilities (Corrected Definition v2)
CREATE TABLE public.vulnerabilities (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID REFERENCES public.workspaces(id) ON DELETE CASCADE,
    asset_id UUID REFERENCES public.assets(id) ON DELETE CASCADE,
    scan_id UUID REFERENCES public.scans(id) ON DELETE SET NULL,
    cve_id TEXT,
    title TEXT NOT NULL,
    description TEXT,
    severity public.severity_level DEFAULT 'Medium'::public.severity_level,
    cvss_score DECIMAL(3,1),
    cvss_vector TEXT,
    status public.vulnerability_status DEFAULT 'open'::public.vulnerability_status, -- Corrected CAST type
    port INTEGER, -- Allows NULL
    service TEXT,
    proof_of_concept TEXT,
    remediation_steps TEXT,
    "references" TEXT[], -- QUOTED COLUMN NAME
    discovered_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT vulnerabilities_logical_key UNIQUE (asset_id, title, port)
);

-- 7. Workspace User Access (Many-to-Many)
CREATE TABLE public.workspace_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID REFERENCES public.workspaces(id) ON DELETE CASCADE,
    user_id UUID REFERENCES public.user_profiles(id) ON DELETE CASCADE,
    role TEXT DEFAULT 'viewer',
    can_scan BOOLEAN DEFAULT false,
    can_export BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(workspace_id, user_id)
);

-- 8. Essential Indexes
CREATE INDEX idx_user_profiles_email ON public.user_profiles(email);
CREATE INDEX idx_user_profiles_role ON public.user_profiles(role);
CREATE INDEX idx_workspaces_owner_id ON public.workspaces(owner_id);
CREATE INDEX idx_workspaces_active ON public.workspaces(is_active);
CREATE INDEX idx_assets_workspace_id ON public.assets(workspace_id);
CREATE INDEX idx_assets_ip ON public.assets(ip_address);
CREATE INDEX idx_assets_risk_score ON public.assets(risk_score DESC);
CREATE INDEX idx_scans_workspace_id ON public.scans(workspace_id);
CREATE INDEX idx_scans_status ON public.scans(status);
CREATE INDEX idx_vulnerabilities_workspace_id ON public.vulnerabilities(workspace_id);
CREATE INDEX idx_vulnerabilities_asset_id ON public.vulnerabilities(asset_id);
CREATE INDEX idx_vulnerabilities_severity ON public.vulnerabilities(severity);
CREATE INDEX idx_vulnerabilities_status ON public.vulnerabilities(status);
CREATE INDEX idx_workspace_users_workspace_id ON public.workspace_users(workspace_id);
CREATE INDEX idx_workspace_users_user_id ON public.workspace_users(user_id);

-- 9. Functions (MUST BE BEFORE RLS POLICIES)
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER
SECURITY DEFINER
LANGUAGE plpgsql
AS $$
BEGIN
  INSERT INTO public.user_profiles (id, email, full_name, role, organization)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'full_name', split_part(NEW.email, '@', 1)),
    COALESCE((NEW.raw_user_meta_data->>'role')::public.user_role, 'analyst'::public.user_role),
    NEW.raw_user_meta_data->>'organization'
  );
  RETURN NEW;
END;
$$;

CREATE OR REPLACE FUNCTION public.update_updated_at()
RETURNS TRIGGER
SECURITY DEFINER
LANGUAGE plpgsql
AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$;

-- 10. Enable RLS
ALTER TABLE public.user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.workspaces ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.assets ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.scans ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.vulnerabilities ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.workspace_users ENABLE ROW LEVEL SECURITY;

-- 11. RLS Policies (Pattern 1 for user_profiles, Pattern 2 for others)

-- Pattern 1: Core user table (user_profiles) - Simple direct access
CREATE POLICY "users_manage_own_user_profiles"
ON public.user_profiles
FOR ALL
TO authenticated
USING (id = auth.uid())
WITH CHECK (id = auth.uid());

-- Pattern 2: Simple user ownership for workspaces
CREATE POLICY "users_manage_own_workspaces"
ON public.workspaces
FOR ALL
TO authenticated
USING (owner_id = auth.uid())
WITH CHECK (owner_id = auth.uid());

-- Workspace access through workspace_users table
CREATE POLICY "workspace_members_can_view_workspace"
ON public.workspaces
FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.workspace_users wu
    WHERE wu.workspace_id = id AND wu.user_id = auth.uid()
  )
);

-- Pattern 2: Assets belong to workspace owner or members (CORRECTED POLICY)
CREATE POLICY "workspace_members_manage_assets"
ON public.assets
FOR ALL
TO authenticated
USING (
  workspace_id IN (
    SELECT w.id FROM public.workspaces w
    WHERE w.owner_id = auth.uid()
    OR EXISTS (
      SELECT 1 FROM public.workspace_users wu
      WHERE wu.workspace_id = w.id AND wu.user_id = auth.uid()
    )
  )
)
WITH CHECK (
  workspace_id IN (
    SELECT w.id FROM public.workspaces w
    WHERE w.owner_id = auth.uid()
    OR EXISTS (
      SELECT 1 FROM public.workspace_users wu
      WHERE wu.workspace_id = w.id AND wu.user_id = auth.uid()
    )
  )
);

-- Pattern 2: Scans access
CREATE POLICY "workspace_members_manage_scans"
ON public.scans
FOR ALL
TO authenticated
USING (
  workspace_id IN (
    SELECT w.id FROM public.workspaces w
    WHERE w.owner_id = auth.uid()
    OR EXISTS (
      SELECT 1 FROM public.workspace_users wu
      WHERE wu.workspace_id = w.id AND wu.user_id = auth.uid()
    )
  )
)
WITH CHECK (
  workspace_id IN (
    SELECT w.id FROM public.workspaces w
    WHERE w.owner_id = auth.uid()
    OR EXISTS (
      SELECT 1 FROM public.workspace_users wu
      WHERE wu.workspace_id = w.id AND wu.user_id = auth.uid() AND wu.can_scan = true
    )
  )
);

-- Pattern 2: Vulnerabilities access
CREATE POLICY "workspace_members_manage_vulnerabilities"
ON public.vulnerabilities
FOR ALL
TO authenticated
USING (
  workspace_id IN (
    SELECT w.id FROM public.workspaces w
    WHERE w.owner_id = auth.uid()
    OR EXISTS (
      SELECT 1 FROM public.workspace_users wu
      WHERE wu.workspace_id = w.id AND wu.user_id = auth.uid()
    )
  )
)
WITH CHECK (
  workspace_id IN (
    SELECT w.id FROM public.workspaces w
    WHERE w.owner_id = auth.uid()
    OR EXISTS (
      SELECT 1 FROM public.workspace_users wu
      WHERE wu.workspace_id = w.id AND wu.user_id = auth.uid()
    )
  )
);

-- Pattern 2: Workspace users - owners and members can manage
CREATE POLICY "workspace_owners_manage_users"
ON public.workspace_users
FOR ALL
TO authenticated
USING (
  workspace_id IN (
    SELECT id FROM public.workspaces WHERE owner_id = auth.uid()
  )
  OR user_id = auth.uid()
)
WITH CHECK (
  workspace_id IN (
    SELECT id FROM public.workspaces WHERE owner_id = auth.uid()
  )
);

-- 12. Triggers
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

CREATE TRIGGER update_user_profiles_updated_at
  BEFORE UPDATE ON public.user_profiles
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();

CREATE TRIGGER update_workspaces_updated_at
  BEFORE UPDATE ON public.workspaces
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();

CREATE TRIGGER update_assets_updated_at
  BEFORE UPDATE ON public.assets
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();

CREATE TRIGGER update_vulnerabilities_updated_at
  BEFORE UPDATE ON public.vulnerabilities
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();

-- 13. Mock Data with Complete Auth Users
DO $$
DECLARE
    admin_uuid UUID := gen_random_uuid();
    analyst_uuid UUID := gen_random_uuid();
    workspace1_uuid UUID := gen_random_uuid();
    workspace2_uuid UUID := gen_random_uuid();
    asset1_uuid UUID := gen_random_uuid();
    asset2_uuid UUID := gen_random_uuid();
    asset3_uuid UUID := gen_random_uuid();
    scan1_uuid UUID := gen_random_uuid();
    scan2_uuid UUID := gen_random_uuid();
BEGIN
    -- Create complete auth.users records with all required fields
    INSERT INTO auth.users (
        id, instance_id, aud, role, email, encrypted_password, email_confirmed_at,
        created_at, updated_at, raw_user_meta_data, raw_app_meta_data,
        is_sso_user, is_anonymous, confirmation_token, confirmation_sent_at,
        recovery_token, recovery_sent_at, email_change_token_new, email_change,
        email_change_sent_at, email_change_token_current, email_change_confirm_status,
        reauthentication_token, reauthentication_sent_at, phone, phone_change,
        phone_change_token, phone_change_sent_at
    ) VALUES
        (admin_uuid, '00000000-0000-0000-0000-000000000000', 'authenticated', 'authenticated',
         'admin@vulcanscan.com', crypt('VulcanScan2024!', gen_salt('bf', 10)), now(), now(), now(),
         '{"full_name": "Security Administrator", "role": "admin", "organization": "Vulcan Security"}'::jsonb,
         '{"provider": "email", "providers": ["email"]}'::jsonb,
         false, false, '', null, '', null, '', '', null, '', 0, '', null, null, '', '', null),
        (analyst_uuid, '00000000-0000-0000-0000-000000000000', 'authenticated', 'authenticated',
         'analyst@vulcanscan.com', crypt('AnalystPass123!', gen_salt('bf', 10)), now(), now(), now(),
         '{"full_name": "Security Analyst", "role": "analyst", "organization": "Vulcan Security"}'::jsonb,
         '{"provider": "email", "providers": ["email"]}'::jsonb,
         false, false, '', null, '', null, '', '', null, '', 0, '', null, null, '', '', null);

    -- Create workspaces
    INSERT INTO public.workspaces (id, name, description, owner_id, client_name, client_contact_email) VALUES
        (workspace1_uuid, 'Acme Corporation', 'Primary enterprise client', admin_uuid, 'Acme Corp', 'security@acme.com'),
        (workspace2_uuid, 'Tech Solutions Inc', 'Technology consulting firm', admin_uuid, 'Tech Solutions', 'admin@techsolutions.com');

    -- Create assets
    INSERT INTO public.assets (id, workspace_id, hostname, ip_address, asset_type, operating_system, os_version, open_ports, risk_score, last_scan_at) VALUES
        (asset1_uuid, workspace1_uuid, 'web-server-01.acme.local', '192.168.1.100', 'server', 'Windows Server 2019', '10.0.17763', ARRAY[80, 443, 3389, 135, 139, 445], 9.2, now() - interval '2 hours'),
        (asset2_uuid, workspace1_uuid, 'db-primary.acme.local', '192.168.1.50', 'database', 'Ubuntu 20.04 LTS', '20.04.3', ARRAY[22, 3306, 443], 8.7, now() - interval '2 hours'),
        (asset3_uuid, workspace1_uuid, 'mail-server.acme.local', '192.168.1.25', 'server', 'CentOS 8', '8.4.2105', ARRAY[25, 110, 143, 993, 995, 22], 8.1, now() - interval '3 hours');

    -- Create scans
    INSERT INTO public.scans (id, workspace_id, name, description, scan_type, status, target_count, progress, started_at, created_by) VALUES
        (scan1_uuid, workspace1_uuid, 'Full Network Scan - Production', 'Comprehensive vulnerability scan of production environment', 'vulnerability_scan', 'running', 245, 67, now() - interval '2 hours', admin_uuid),
        (scan2_uuid, workspace2_uuid, 'Web Application Security Test', 'OWASP Top 10 security assessment', 'web_app_scan', 'completed', 12, 100, now() - interval '4 hours', analyst_uuid);

    -- Create vulnerabilities
    INSERT INTO public.vulnerabilities (workspace_id, asset_id, scan_id, cve_id, title, description, severity, cvss_score, status, port, service, remediation_steps, discovered_at) VALUES
        (workspace1_uuid, asset1_uuid, scan1_uuid, 'CVE-2024-0001', 'Critical Remote Code Execution in Apache HTTP Server',
         'A critical vulnerability in Apache HTTP Server allows remote attackers to execute arbitrary code through malformed HTTP requests. This affects versions 2.4.0 through 2.4.58 and requires immediate patching.',
         'Critical', 9.8, 'open', 80, 'HTTP', 'Update Apache HTTP Server to version 2.4.59 or later. Apply security patches immediately.', now() - interval '1 day'),

        (workspace1_uuid, asset2_uuid, scan1_uuid, 'CVE-2024-0002', 'SQL Injection in Custom Web Application',
         'Multiple SQL injection vulnerabilities found in the customer portal application. Attackers can extract sensitive database information and potentially gain administrative access.',
         'High', 8.5, 'confirmed', 3306, 'MySQL', 'Implement parameterized queries and input validation. Update application code to prevent SQL injection attacks.', now() - interval '2 days'),

        (workspace1_uuid, asset1_uuid, scan1_uuid, 'CVE-2024-0003', 'Privilege Escalation in Windows Server',
         'Local privilege escalation vulnerability in Windows Server 2019 and 2022. Allows authenticated users to gain SYSTEM-level privileges through registry manipulation.',
         'High', 8.2, 'open', 3389, 'RDP', 'Install Windows security updates KB5028997 and KB5028999. Restrict RDP access to authorized users only.', now() - interval '3 days'),

        (workspace1_uuid, asset3_uuid, scan1_uuid, 'CVE-2024-0004', 'Cross-Site Scripting in Web Portal',
         'Stored XSS vulnerability in the employee portal allows attackers to inject malicious scripts. Could lead to session hijacking and data theft from authenticated users.',
         'Medium', 6.1, 'false_positive', 443, 'HTTPS', 'Implement proper input sanitization and output encoding. Use Content Security Policy headers.', now() - interval '4 days'),

        (workspace1_uuid, asset1_uuid, scan1_uuid, 'CVE-2024-0005', 'Weak SSL/TLS Configuration',
         'Multiple servers are using outdated SSL/TLS protocols and weak cipher suites. This could allow man-in-the-middle attacks and data interception.',
         'Medium', 5.9, 'accepted', 443, 'HTTPS', 'Update SSL/TLS configuration to use TLS 1.2 or higher. Disable weak cipher suites and enable perfect forward secrecy.', now() - interval '5 days');

    -- Create workspace user relationships
    INSERT INTO public.workspace_users (workspace_id, user_id, role, can_scan, can_export) VALUES
        (workspace1_uuid, analyst_uuid, 'analyst', true, true),
        (workspace2_uuid, analyst_uuid, 'viewer', false, false);

EXCEPTION
    WHEN foreign_key_violation THEN
        RAISE NOTICE 'Foreign key error: %', SQLERRM;
    WHEN unique_violation THEN
        RAISE NOTICE 'Unique constraint error: %', SQLERRM;
    WHEN OTHERS THEN
        RAISE NOTICE 'Unexpected error: %', SQLERRM;
END $$;